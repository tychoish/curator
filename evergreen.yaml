####################################################
#   Evergreen Go Project Configuration (Curator)   #
####################################################

variables:
  # YAML variables and templates used to reduce redundancy later in
  # the config.
  - &run-suite
    # fetches the tests dist package and runs a make target and then
    # uploads. The test name should correspond to a make target for
    # that suite. In the "post" task, the results are uploaded to
    # evergreen.
    name: test
    depends_on:
      - name: build
    commands:
      - func: setup-credentials
      - func: get-dist
        vars: { dist: "dist-test"}
      - func: run-make
        vars: { target: "${task_name}" }

  # Task lists for build variants. Some (known) duplication between
  # these lists and the task definitions below.
  - &test-tasks
      # this should be build+all test suite names. to add a new test you
      # must additionally add the test suite name to the dev-tasks list
      # bellow and the task list, using the run-go-suite template
      - name: build
      - name: test-curator
      - name: test-main
      - name: test-operations
      - name: test-sthree
      - name: test-repobuilder
      - name: push
  - &dev-tasks
      # dev tasks contains all the test suites plus coverage and
      # linting, and the race detector this is a special builder.
      - name: build
      - name: lint
      - name: test-curator
      - name: test-main
      - name: test-operations
      - name: test-sthree
      - name: test-repobuilder
      - name: coverage
      - name: push
  - &race-detector-tasks
      - name: build
      - name: race-curator
      - name: race-main
      - name: race-sthree
      - name: race-operations
      - name: race-repobuilder


#######################################
#              Functions              #
#######################################
functions:
  setup-credentials:
    command: shell.exec
    params:
       silent: true
       script: |
         mkdir ~/.aws

         cat <<EOF > ~/.aws/config
         [default]
         region = us-east-1
         EOF

         cat <<EOF > ~/.aws/credentials
         [default]
         aws_access_key_id = ${aws_key}
         aws_secret_access_key = ${aws_secret}
         EOF
  get-dist:
    command: s3.get
    params:
      aws_key: ${aws_key}
      aws_secret: ${aws_secret}
      bucket: mciuploads
      remote_file: curator/${build_id}-${build_variant}/curator-${dist|dist}-${revision}.tar.gz
      extract_to: ${path|gopath/src/github.com/mongodb/curator}
  run-make:
    command: shell.exec
    params:
      working_dir: gopath/src/github.com/mongodb/curator
      script: |
         set -o errexit
         set -o verbose

         # Configure a local go path for this build.
         export GOPATH=${workdir}/gopath/

         # Run make, called with proper environment variables set,
         # running the target.
         ${build_env} make ${target}
  upload-coverage:
    command: s3.put
    params:
      aws_key: ${aws_key}
      aws_secret: ${aws_secret}
      local_file: gopath/src/github.com/mongodb/curator/build/coverage.${name}.html
      remote_file: curator/${task_id}/${name}-coverage.html
      bucket: mciuploads
      content_type: text/html
      permissions: public-read
      display_name: coverage-${name}
  upload-dist:
    command: s3.put
    params:
      aws_key: ${aws_key}
      aws_secret: ${aws_secret}
      local_file: gopath/src/github.com/mongodb/curator/build/${dist}.tar.gz
      remote_file: curator/${build_id}-${build_variant}/curator-${dist}-${revision}.tar.gz
      bucket: mciuploads
      content_type: application/x-gzip
      permissions: public-read
      display_name: curator-${dist}.tar.gz


#######################################
#                Tasks                #
#######################################
tasks:
  # the build (with and without the race detector) and lint tasks use
  # a template that does not include test result parsing.
  - name: build
    commands:
      - command: git.get_project
        params:
          directory: gopath/src/github.com/mongodb/curator
      - func: run-make
        vars: { target: "vendor build dist dist-test dist-source" }
      - func: upload-dist
        vars: { dist: "dist"}
      - func: upload-dist
        vars: { dist: "dist-source"}
      - func: upload-dist
        vars: { dist: "dist-test"}
  - name: lint
    depends_on:
      - name: build
    commands:
      - func: get-dist
        vars: { dist: "dist-source", path: "gopath/src/github.com/mongodb"}
      - func: run-make
        vars: { target: "lint"}
  # The coverage task is less generic.
  - name: coverage
    depends_on:
      - name: build
    commands:
      - func: setup-credentials
      - func: get-dist
        vars: { dist: "dist-test"}
      - func: get-dist
        vars: { dist: "dist-source", path: "gopath/src/github.com/mongodb"}
      - func: run-make
        vars: { target: "coverage-html"}
      - func: upload-coverage
        vars: { name: "main"}
      - func: upload-coverage
        vars: { name: "operations"}
      - func: upload-coverage
        vars: { name: "curator"}
      - func: upload-coverage
        vars: { name: "sthree"}
      - func: upload-coverage
        vars: { name: "repobuilder"}

  # define tasks for all test suites (modules)
  - <<: *run-suite
    name: test-operations
  - <<: *run-suite
    name: test-main
  - <<: *run-suite
    name: test-curator
  - <<: *run-suite
    name: test-sthree
  - <<: *run-suite
    name: test-repobuilder

  # run the suites with the race detector (one variant only)
  - <<: *run-suite
    name: race-operations
  - <<: *run-suite
    name: race-main
  - <<: *run-suite
    name: race-curator
  - <<: *run-suite
    name: race-sthree
  - <<: *run-suite
    name: race-repobuilder

  - name: push
    patchable: false
    depends_on:
    - name: "*"
    stepback: false
    commands:
      - command: s3Copy.copy
        params:
          aws_key: ${aws_key}
          aws_secret: ${aws_secret}
          s3_copy_files:
          - {'source': { 'path': 'curator/${build_id}-${build_variant}/curator-dist-${revision}.tar.gz', 'bucket': 'mciuploads' },
             'destination': { 'path': 'build/curator/curator-dist-${build_variant}-${revision}.tar.gz', 'bucket': 'boxes.10gen.com' }
            }


post:
  - command: gotest.parse_files
    params:
      files:
        - "gopath/src/github.com/mongodb/curator/build/output.*.test"
        - "gopath/src/github.com/mongodb/curator/build/output.*.race"
  - command: shell.exec
    params:
      script: |
        rm -rf ~/.aws

#######################################
#           Buildvariants             #
#######################################
buildvariants:
  - name: archlinux
    display_name: Arch Linux
    run_on:
      - archlinux-test
    tasks:
      *dev-tasks

  - name: race-detector
    display_name: Race Detector (Arch Linux)
    run_on:
      - archlinux-test
    tasks:
      *race-detector-tasks

  - name: rhel70
    display_name: RHEL 7.0
    expansions:
      build_env: "PATH=/opt/go:$PATH"
    run_on:
      - rhel70-small
    tasks:
      *test-tasks

  - name: rhel62
    display_name: RHEL 6.2
    run_on:
      - rhel62-test
    tasks:
      *test-tasks

  - name: rhel55
    display_name: RHEL 5.5 (gccgo)
    expansions:
      build_env: "LD_LIBRARY_PATH=/opt/openssl/lib64 PATH=/opt/mongodbtoolchain/v2/bin:$PATH"
    run_on:
      - rhel55-test
    tasks:
      *test-tasks

  - name: debian81
    display_name: Debian 8.1
    expansions:
      build_env: "PATH=/opt/go/bin:$PATH GOROOT=/opt/go"
    run_on:
      - debian81-test
    tasks:
      *test-tasks

  - name: osx
    display_name: OS X 10.10
    expansions:
      build_env: "PATH=/usr/local/go/bin:$PATH"
    run_on:
      - osx-1010
    tasks:
      *test-tasks
